/* SubEtha v0.0.0-alpha + Morus v1.0.0 + SubEtha Ad Hoc Exchange | github.com/bemson | (c) 2014, ACPACHE & MIT */
!function(k,l,f,s){function g(){function g(){for(var b={},c=m.concat(),d,a,e,f=95;f--;)e=n(p()*f),a=f+32,d=c[e],b[a+"c"]=d,b[d]=a,c.splice(e,1);return b}function e(){this.randomize()}var h={},m=[],f,k=JSON.stringify,l=JSON.parse,p=Math.random,n=Math.round,q=/[ -~]/g,r=/^(\d+)({.+})$/;!function(){for(var b=95,c,d;b--;)c=b+32,d=String.fromCharCode(c),h[c+"c"]=m[b]=d,h[d]=c;f=m.join("")}();e.prototype.encode=function(b){var c=this.key,d=this.index,a;return b.replace(q,function(b){a=h[b];a-=32-d;a%=95;
a+=32;d++;return c[a+"c"]})};e.prototype.decode=function(b){var c=this.key,d=this.index,a;return b.replace(q,function(b){a=c[b];a-=32+d;0>a&&(a%=95)&&(a=95+a);a+=32;d++;return h[a+"c"]})};e.prototype.randomize=function(){this.key=g();this.index=n(95*p());return this};e.prototype.cipher=function(b){var c;return arguments.length?"string"==typeof b&&(c=r.exec(b))?(this.index=+c[1],this.key=l(c[2]),!0):!1:this.index+k(this.key)};e.genKey=g;e.ASCII=f;return e}k?define(g):l?module.exports=g():f.Morus||
(f.Morus=g())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(M,N,z,O,aa,P,ba,ka,m,la){function q(){function A(a){for(var b=1,c,d;c=arguments[b];b++)for(d in c)h.call(c,d)&&(a[d]=c[d]);return a}function q(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ca,da)}function da(a){var b=16*Q()|0;return("x"===a?b:b&3|8).toString(16)}function p(a){return a&&"string"===typeof a}function G(){u.contains(n)&&u.removeChild(n)}function R(a){var b=a.data,c,d,e,f;if(!S&&"string"===typeof b&&"[]"===b.charAt(0)+b.charAt(b.length-1))try{b=T(b)}catch(k){return}H(b)&&
"se-0"==b[0]&&3===b.length&&h.call(r,b[1])&&0<(d=(c=r[b[1]]).state)&&4>d&&(e=c.decode(b[2]))&&p(e.mid)&&h.call(e,"sent")&&h.call(e,"msg")&&h.call(U,f=e.type)&&(e.sent=new O(e.sent),U[f](c,e.msg,e,a))}function v(){var a=B,b;u=C.body;w(m,"DOMContentLoaded",v);w(m,"load",v);I=function(a){var b=a.url;(h.call(r,b)?r[b]:r[b]=new V(b)).addClient(a)};W=function(a){var b=a._bridge(J);b&&b.removeClient(a)};B=0;for(b in a)I(a[b])}function X(a,b,c,d,e,f,k,g){var l;h.call(a,b)&&h.call((l=a[b]).peers,c)&&(a=l.peers[c],
g={id:k.mid,peer:a,sent:k.sent,timeStamp:g.timeStamp},d(l,a,g,k))}function Y(a,b,c,d){return!!p(b)&&a._transmit("event",d,{type:b,data:1<c.length?[].concat(c):[]})}function s(a,b){var c=a.state;b!==c&&(a.state=b,a.fire("::readyStateChange",b,c),a.state===b&&(0===b&&(a.peers={},2<c&&a.fire("::disconnect")),3===b&&a.fire("::connect")))}function K(){}function V(a){var b=this,c=C.createElement("iframe"),d=new ea;b.iframe=c;b.id=a;b.cipher=d;b.clients={};b.channels={};b.channelCnts={};b.ping=["se-0",Z,
a,d.cipher()].join("`");$++||(x(m,"message",R),x(m,"unload",G));b.onLoad=function(){3>b.state?(b.iframe.contentWindow.postMessage(b.ping,"*"),b.state=2):b.destroy()};x(c,"load",b.onLoad);h.call(y.urls,a)?c.src=y.urls[a]:c.src=a;b.dDay(y.bridgeTimeout);n.appendChild(c);b.inDom()||u.appendChild(n)}function D(){this.peers={};this.credentials=[]}function E(a,b){this._client=b;a&&(this.id=a.id,this.origin=a.origin,this.start=new O(a.start),this.channel=a.channel)}var ea=N||M?require("morus"):m.Morus,fa=
P.stringify,T=P.parse,Q=aa.random,h=ba.prototype.hasOwnProperty,F=z.prototype.slice,C=document,u,ca=/[xy]/g,Z=Q(),t={},ga=/^([\w\-]+\.)+[conmi]\w{1,2}\b/,ha=/^[^{]{0,40}({.+})[^}]{0,40}$/,L="f"==location.protocol.charAt(0),ia=L?"http://":"//",n=C.createElement("div"),r={},$=0,B={},J={},I=function(a){B[a.id]=a},W=function(a){delete B[a.id];s(a,0)},S=!!function(){var a=1;try{m.postMessage({toString:function(){a=0}},"*")}catch(b){}return a}(),ja=S?function(a,b){a.postMessage(b,"*")}:function(a,b){a.postMessage(fa(b),
"*")},x=m.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,b,c){a.addEventListener(b,c,!1)},w=m.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},H="function"===typeof z.isArray?z.isArray:function(a){return a instanceof z},U={ready:function(a,b){var c=a.clients,d;a.dDay();a.origin=b;a.state=3;for(d in c)a.auth(c[d])},auth:function(a,b){var c=a.channels,d=a.clients,e=b.id,f,k,g,l;if(h.call(d,e))if(d=d[e],g=b.peers,b.ok&&2===d.state){k=
d.peers={};for(l in g){f=1;var m=g[l];d.peers[m.id]=new E(m,d)}g=d.channel;h.call(c,g)||(c[g]={},a.channelCnts[g]=0);c[g][e]=d;a.channelCnts[g]++;s(d,3);if(f&&3===d.state)for(l in k)d.fire("::join",k[l])}else a.remove(d)},net:function(a,b){var c,d,e,f=b.joins,k=b.drops,g,l,h;for(h=f.length;h--;){e=f[h];g=e.id;c=a.channels[e.channel];for(d in c)d!=g&&(l=c[d],l.peers[e.id]=new E(e,l));for(d in c)d!=g&&(e=c[d],e.fire("::join",e.peers[g]))}for(h=k.length;h--;){f=[];e=k[h];g=e.id;c=a.channels[e.channel];
for(d in c)d!=g&&(e=c[d],l=e.peers[g],f.push([e,l]),l.state=0,delete e.peers[g]);for(c=f.length;c--;)e=f[c][0],e.id!=g&&e.fire("::drop",f[c][1])}},die:function(a){a.deref();a.destroy()},client:function(a,b,c,d){a=a.clients;var e=b.from,f=y.msgType,k,g,l;if("object"===typeof f&&h.call(f,b.type))if(f=f[b.type],l=b.to,k=b.data,l)for(g=l.length;g--;)X(a,l[g],e,f,k,b,c,d);else for(g in a)X(a,g,e,f,k,b,c,d)}},y={bridgeTimeout:8E3,guid:q,Client:D,Peer:E,EventEmitter:K,version:"0.0.0",protocol:"se-0",urls:{"public":(L?
"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/public_bridge.html",local:"javascript:'<script src=\""+(L?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/subetha-bridge.min.js\">\x3c/script>'"},msgType:{event:function(a,b,c,d){d=d.msg.data;b=d.data;d=d.type;c.type=d;c.data=[].concat(b);b.length?a.fire.apply(a,[d,c].concat(b)):a.fire(d,c)}}};t["::drop"]=1;t["::join"]=1;t["::readyStateChange"]=1;t["::connect"]=1;t["::disconnect"]=1;n.style.display="none";n.setAttribute("aria-hidden","true");
n.setAttribute("hidden","hidden");n.setAttribute("data-owner","subetha");A(K.prototype,{on:function(a,b,c){p(a)&&"function"===typeof b&&(h.call(this,"_evts")||(this._evts={}),h.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push({cb:b,ctx:c||this,fctx:2<arguments.length}));return this},off:function(a,b,c){var d,e,f,k=0,g=3>arguments.length,l;if(!h.call(this,"_evts")||!arguments.length)this._evts={};else if(p(a)&&h.call(this._evts,a)){if(b){d=this._evts[a];for(e=this._evts[a]=[];f=d[k];++k)(f.cb!==
b||g&&f.fctx||f.ctx!==c)&&e.push(f);e.length||(l=1)}else l=1;l&&delete this._evts[a]}return this},fire:function(a){var b,c,d,e,f;if(p(a)&&h.call(this,"_evts")&&h.call(this._evts,a)&&(c=this._evts[a]).length)for(b=F.call(arguments,1),f=b.length?function(a){a.cb.apply(a.ctx,b)}:function(a){a.cb.call(a.ctx)},d=c.length,e=0;e<d;++e)f(c[e]);return this}});A(V.prototype,{failures:0,state:1,cnt:0,addClient:function(a){var b=this,c=b.clients,d=a.id;h.call(c,d)||(b.cnt++,a._bridge=function(a){return a===J&&
b},c[d]=a);3==b.state&&b.auth(a)},removeClient:function(a){var b=a.id,c=a.channel;--this.cnt?(delete this.clients[b],1<a.state&&(delete this.channels[c][b],1==this.channelCnts[c]--&&delete this.channelCnts[c]),this.drop(a)):this.destroy()},auth:function(a){var b;s(a,2);2==a.state&&(b=a.credentials,H(b)||(b=[b]),this.send("auth",{id:a.id,channel:a.channel,creds:b}))},destroy:function(){var a=this.state,b=this.iframe,c=this.clients,d;this.dDay();this.state=4;this.clients={};this.cnt=0;for(d in c)this.drop(c[d]);
this.cnt?this.state=a:(this.deref(),w(b,"load",this.onLoad),--$||(w(m,"message",R),w(m,"unload",G),G()),n.contains(b)&&n.removeChild(b))},deref:function(){delete r[this.id]},drop:function(a){var b=a.state;delete a._bridge;1<b&&4>b&&(this.send("drop",a.id),3==b&&s(a,4));a.peers={};4==a.state&&s(a,0)},decode:function(a){var b=this.cipher,c;if(p(a)&&(c=b.decode(a))&&(c=ha.exec(c)))try{return c=T(c[1]),b.shift++,c}catch(d){}3===++this.failures&&this.destroy();return 0},inDom:function(){var a=this.iframe;
return n.contains(a)&&u.contains(a)},dDay:function(a){var b=this;clearTimeout(b.timer);a&&(b.timer=setTimeout(function(){b.destroy()},a))},send:function(a,b){var c;if(3!=this.state)return 0;c=q();ja(this.iframe.contentWindow,{key:Z,mid:c,type:a,msg:b});return c}});D.prototype=new K;A(D.prototype,{id:"",channel:"lobby",url:"local",state:0,_bridge:function(){return!1},emit:function(a){var b=arguments;return Y(this,a,1<b.length?F.call(b,1):[],0)},open:function(a){var b=this.channel,c=this.url,d=arguments,
e=this.state,f;p(a)&&(f=a.indexOf("@"),~f?(b=a.substring(0,f)||b,c=a.substring(f+1)||c):b=a,1<d.length&&(this.credentials=F.call(d,1)));ga.test(c)&&(c=ia+c);if(2<e){if(b==this.channel&&c==this.url)return;this.close()}this.channel=b;this.url=c;2>e&&(this.id=q(),s(this,1),1==this.state&&I(this));return this},close:function(){var a=this.state;0<a&&4>a&&W(this);return this},_transmit:function(a,b,c){var d=this._bridge(J),e;if((e=d&&3==d.state&&3==this.state&&p(a)&&!h.call(t,a))&&!(e=!b)){a:{e=this.peers;
var f=[],k,g;H(b)||(b=[b]);for(g=b.length;g--;){k=b[g];k instanceof Subetha.Peer&&(k=k.id);if(!h.call(e,k)){e=0;break a}f.push(k)}e=f}e=b=e}return e?d.send("client",{type:a,from:this.id,to:b?[].concat(b):0,data:c}):!1}});A(E.prototype,{state:3,send:function(a){var b=arguments;return this.state?Y(this._client,a,1<b.length?F.call(b,1):[],this.id):!1}});"function"!==typeof m.postMessage?D.prototype.open=function(){return this}:C.body?v():(x(m,"DOMContentLoaded",v),x(m,"load",v));return y}M?define(q):
N?module.exports=q():m.Subetha||(m.Subetha=q())}("function"===typeof define,"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);
!function(t,u,y,C,D,E,z,A,v,F){function k(){function k(a,b,d){var c,e=b[0],f,h;if(!e||"string"!=typeof e)return!1;if(d)f=[d];else for(h in c=a.peers,f=[],c)f.push(h);if(h=f.length){c=B();b=b.length?p.call(b,1):[];if(!a._transmit("exchange",d,{xid:c,idx:0,type:e,data:b}))return!1;for(;h--;)q(a,c,f[h]).push(e);return c}}function q(a,b,d){var c;g.call(a,"_ax")||(c=a._ax={xids:{},cbs:{}},a.on("::disconnect",w));b&&!g.call(a._ax.xids,b)&&(c=a._ax.xids[b]={pids:{},cnt:0});d&&!g.call(a._ax.xids[b].pids,
d)&&(a._ax.xids[b].cnt++,c=[],c.endFn=function(){return!!n(a,b,d)},c=a._ax.xids[b].pids[d]=c);return c}function w(){var a=this._ax.xids,b;this.off("::disconnect",w);for(b in a)r(this,b,a[b],1);delete this._ax}function r(a,b,d){var c,e,f;if(g.call(a,"_ax")&&(c=a._ax.xids,(e=c[b])&&g.call(e.pids,d)))return f=e.pids[d],delete e.pids[d],--e.cnt||delete c[b],a=a.peers[d],a._client.fire("::endExchange",a,f.concat()),1}function n(a,b,d){a._transmit("exchange",d,{xid:b,xkill:1});r(a,b,d)}var l=u||t?require("subetha"):
v.Subetha,B=l.guid,s=l.Client,x=l.Peer,p=y.prototype.slice,g=z.prototype.hasOwnProperty;s.prototype.adhoc=function(){var a=arguments,b=a[a.length-1];if(2>a.length||"function"!=typeof b)return!1;q(this);this._ax.cbs["="+p.call(a,0,-1).join()]=b;return!0};s.prototype.unhoc=function(){var a,b,d=!1;if(g.call(this,"_ax"))for(b in a=p.call(arguments),"function"==typeof a[a.length-1]&&(a=a.slice(0,-1)),a="="+a.join(),chainRxp=new A("^"+a),a=this._ax.cbs,a)chainRxp.test(b)&&(d=!0,delete a[b]);return d};s.prototype.ask=
function(){return k(this,arguments)};x.prototype.ask=function(){return k(this._client,arguments,this.id)};x.prototype.endExchange=function(a){var b=this.id,d=this._client,c=this._ax,e=!1,f=!a,h,g;if(c)for(g in c)if(h=g==a,f||h||c[g].chain[0]==a)if(n(d,b,g),e=!0,h)break;return e};Subetha.msgType.exchange=function(a,b,d,c){c=c.msg.data;var e=c.xid,f=b.id,h,k,m,l;g.call(a,"_ax")?g.call(c,"xkill")?r(a,e,f):(q(a,e,f),k=a._ax,b=c.type,h=c.idx,m=k.xids[e].pids[f],l="="+m.concat(b).join(),g.call(k.cbs,l)&&
m.length==h?(m.push(b),d.type=b,d.data=c.data,d.exchange=e,d.end=m.endFn,d.reply=function(){var b,c;return g.call(k.xids,e)&&m.length==h+1?(b=arguments,c=b[0],m.push(c),b=p.call(b,1),a._transmit("exchange",f,{xid:e,idx:h+1,type:c,data:b})):!1},d.thread=m.concat(),a.fire("::exchange",d,a.peers[f]),g.call(k.cbs,l)?(cb=k.cbs[l],c.data.length?cb.apply(a,[d].concat(c.data)):cb.call(a,d)):n(a,e,f)):n(a,e,f)):n(a,e,f)};return l}t?define(k):u?module.exports=k():v.Subetha&&k()}("function"===typeof define,
"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);