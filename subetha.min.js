/* SubEtha v0.0.1-alpha + Morus v1.0.0 + SubEtha Client, Peer-Events, and Ad Hoc-Exchange | github.com/bemson | (c) 2014, ACPACHE & MIT */
!function(r,x,n,B){function h(){function n(){for(var f={},t=d.concat(),k,g,a,e=95;e--;)a=r(A()*e),g=e+32,k=t[a],f[g+"c"]=k,f[k]=g,t.splice(a,1);return f}function u(){this.randomize()}var h={},d=[],v,f=JSON.stringify,J=JSON.parse,A=Math.random,r=Math.round,w=/[ -~]/g,x=/^(\d+)({.+})$/;!function(){for(var f=95,t,k;f--;)t=f+32,k=String.fromCharCode(t),h[t+"c"]=d[f]=k,h[k]=t;v=d.join("")}();u.prototype.encode=function(d){var f=this.key,k=this.index,g;return d.replace(w,function(a){g=h[a];g-=32-k;g%=95;
g+=32;k++;return f[g+"c"]})};u.prototype.decode=function(d){var f=this.key,k=this.index,g;return d.replace(w,function(a){g=f[a];g-=32+k;0>g&&(g%=95)&&(g=95+g);g+=32;k++;return h[g+"c"]})};u.prototype.randomize=function(){this.key=n();this.index=r(95*A());return this};u.prototype.cipher=function(d){var t;return arguments.length?"string"==typeof d&&(t=x.exec(d))?(this.index=+t[1],this.key=J(t[2]),!0):!1:this.index+f(this.key)};u.genKey=n;u.ASCII=v;return u}r?define(h):x?module.exports=h():n.Morus||
(n.Morus=h())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(r,x,n,B,h,E,u,I,d,v){function f(){function f(b){for(var c=1,l,D;l=arguments[c];c++)for(D in l)m.call(l,D)&&(b[D]=l[D]);return b}function v(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ba,F)}function F(b){var c=16*U()|0;return("x"===b?c:c&3|8).toString(16)}function w(b){return b&&"string"===typeof b}function C(){K.contains(y)&&K.removeChild(y)}function I(b){var c=b.data,l,D,a,e;if(!V&&"string"===typeof c&&"[]"===c.charAt(0)+c.charAt(c.length-1))try{c=W(c)}catch(d){return}Q(c)&&
"se-0"==c[0]&&3===c.length&&m.call(G,c[1])&&0<(D=(l=G[c[1]]).state)&&4>D&&(a=l.decode(c[2]))&&w(a.mid)&&m.call(a,"sent")&&m.call(a,"msg")&&m.call(X,e=a.type)&&(a.sent=new B(a.sent),X[e](l,a.msg,a,b))}function t(){var b=O,c;K=z.body;L(d,"DOMContentLoaded",t);L(d,"load",t);R=function(b){var c=b.url;(m.call(G,c)?G[c]:G[c]=new e(c)).addClient(b)};Y=function(b){var c=b._bridge(S);c&&c.removeClient(b)};O=0;for(c in b)m.call(b,c)&&R(b[c])}function k(b,c,l,a,e,d,f,s){var g;m.call(b,c)&&m.call((g=b[c]).peers,
l)&&(b=g.peers[l],a(g,b,e,{id:f.mid,peer:b,sent:new B(f.sent),timeStamp:s.timeStamp}))}function g(b,c){var l=b.state;c!==l&&(b.state=c,b.fire("::readyStateChange",c,l),b.state===c&&(0===c&&(b.peers={},2<l&&b.fire("::disconnect")),3===c&&b.fire("::connect")))}function a(){}function e(b){var c=this,l=z.createElement("iframe"),a=new q;c.iframe=l;c.id=b;c.cipher=a;c.clients={};c.channels={};c.channelCnts={};c.ping=["se-0",Z,b,a.cipher()].join("`");$++||(M(d,"message",I),M(d,"unload",C));c.onLoad=function(){3>
c.state?(c.iframe.contentWindow.postMessage(c.ping,"*"),c.state=2):c.destroy()};M(l,"load",c.onLoad);m.call(N.urls,b)?l.src=N.urls[b]:l.src=b;c.dDay(N.bridgeTimeout);y.appendChild(l);c.inDom()||K.appendChild(y)}function p(){this.peers={};this.credentials=[]}function P(b,c){this._client=c;b&&(this.id=b.id,this.origin=b.origin,this.start=new B(b.start),this.channel=b.channel)}var q=x||r?require("morus"):d.Morus,ca=E.stringify,W=E.parse,U=h.random,m=u.prototype.hasOwnProperty,aa=n.prototype.slice,z=
document,K,ba=/[xy]/g,Z=U(),H={},da=/^([\w\-]+\.)+[conmi]\w{1,2}\b/,ea=/^[^{]{0,40}({.+})[^}]{0,40}$/,T="f"==location.protocol.charAt(0),fa=T?"http://":"//",y=z.createElement("div"),G={},$=0,O={},S={},R=function(b){O[b.id]=b},Y=function(b){delete O[b.id];g(b,0)},V=!!function(){var b=1;try{d.postMessage({toString:function(){b=0}},"*")}catch(c){}return b}(),ga=V?function(b,c){b.postMessage(c,"*")}:function(b,c){b.postMessage(ca(c),"*")},M=d.attachEvent?function(b,c,l){b.attachEvent("on"+c,l)}:function(b,
c,l){b.addEventListener(c,l,!1)},L=d.attachEvent?function(b,c,l){b.detachEvent("on"+c,l)}:function(b,c,l){b.removeEventListener(c,l,!1)},Q="function"===typeof n.isArray?n.isArray:function(b){return b instanceof n},X={ready:function(b,c){var l=b.clients,a;b.dDay();b.origin=c;b.state=3;for(a in l)m.call(l,a)&&b.auth(l[a])},auth:function(b,c){var l=b.channels,a=b.clients,e=c.id,d,f,s,p;if(m.call(a,e))if(a=a[e],s=c.peers,c.ok&&2===a.state){f=a.peers={};for(p in s)if(m.call(s,p)){d=1;var q=s[p];a.peers[q.id]=
new P(q,a)}s=a.channel;m.call(l,s)||(l[s]={},b.channelCnts[s]=0);l[s][e]=a;b.channelCnts[s]++;g(a,3);if(d&&3===a.state)for(p in f)m.call(f,p)&&a.fire("::join",f[p],!0)}else b.remove(a)},net:function(b,c){var a,e,f,d=c.joins,p=c.drops,s,g,q,k;for(q=d.length;q--;){s=d[q];g=s.id;a=b.channels[s.channel];k=[];for(e in a)e!=g&&m.call(a,e)&&!m.call((f=a[e]).peers,g)&&(f.peers[s.id]=new P(s,f),k.push(f));for(a=k.length;a--;)f=k[a],f.fire("::join",f.peers[g])}for(q=p.length;q--;){d=[];s=p[q];g=s.id;a=b.channels[s.channel];
for(e in a)e!=g&&m.call(a,e)&&(f=a[e],s=f.peers[g],d.push([f,s]),s.state=0,delete f.peers[g]);for(a=d.length;a--;)f=d[a][0],f.id!=g&&f.fire("::drop",d[a][1])}},die:function(b){b.deref();b.destroy()},client:function(b,c,a,e){b=b.clients;var f=c.from,d=N.msgType,g,p,q;if("object"===typeof d&&m.call(d,c.type))if(d=d[c.type],q=c.to,g=c.data,q)for(p=q.length;p--;)k(b,q[p],f,d,g,c,a,e);else for(p in b)m.call(b,p)&&k(b,p,f,d,g,c,a,e)}},N={bridgeTimeout:1E4,guid:v,Client:p,Peer:P,EventEmitter:a,protocol:"se-0",
urls:{"public":(T?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/public_bridge.html",local:"javascript:'<script src=\""+(T?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/subetha-bridge.min.js\">\x3c/script>'"},msgType:{}};H["::drop"]=1;H["::join"]=1;H["::readyStateChange"]=1;H["::connect"]=1;H["::disconnect"]=1;y.style.display="none";y.setAttribute("aria-hidden","true");y.setAttribute("hidden","hidden");y.setAttribute("data-owner","subetha");f(a.prototype,{on:function(b,c){w(b)&&"function"===
typeof c&&(m.call(this,"_evts")||(this._evts={}),m.call(this._evts,b)||(this._evts[b]=[]),this._evts[b].push(c));return this},off:function(b,c){var a,e,f=arguments.length;if(!m.call(this,"_evts")||!f)this._evts={};else if(w(b)&&m.call(this._evts,b)){a=this._evts[b];if("function"==typeof c)for(e=a.length;e--;)if(a[e]===c){a.splice(e,1);break}(2>f||!a.length)&&delete this._evts[b]}return this},fire:function(b){var c=this,a,e,f,d,g;if(w(b)&&m.call(c,"_evts")&&m.call(c._evts,b)&&(f=(e=c._evts[b]).length))for(a=
aa.call(arguments,1),g=a.length?function(b){b.apply(c,a)}:function(b){b.call(c)},d=0;d<f;d++)g(e[d]);return c}});f(e.prototype,{failures:0,state:1,cnt:0,addClient:function(b){var c=this,a=c.clients,e=b.id;m.call(a,e)||(c.cnt++,b._bridge=function(b){return b===S&&c},a[e]=b);3==c.state&&c.auth(b)},removeClient:function(b){var c=b.id,a=b.channel;--this.cnt?(delete this.clients[c],1<b.state&&(delete this.channels[a][c],1==this.channelCnts[a]--&&delete this.channelCnts[a]),this.drop(b)):this.destroy()},
auth:function(b){var c;g(b,2);2==b.state&&(c=b.credentials,Q(c)||(c=[c]),this.send("auth",{id:b.id,channel:b.channel,creds:c}))},destroy:function(){var b=this.state,c=this.iframe,a=this.clients,e;this.dDay();this.state=4;this.clients={};this.cnt=0;for(e in a)m.call(a,e)&&this.drop(a[e]);this.cnt?this.state=b:(this.deref(),L(c,"load",this.onLoad),--$||(L(d,"message",I),L(d,"unload",C),C()),y.contains(c)&&y.removeChild(c))},deref:function(){delete G[this.id]},drop:function(b){var c=b.state;delete b._bridge;
1<c&&4>c&&(this.send("drop",b.id),3==c&&g(b,4));b.peers={};4==b.state&&g(b,0)},decode:function(b){var c=this.cipher,a;if(w(b)&&(a=c.decode(b))&&(a=ea.exec(a)))try{return a=W(a[1]),c.shift++,a}catch(e){}3===++this.failures&&this.destroy();return 0},inDom:function(){var b=this.iframe;return y.contains(b)&&K.contains(b)},dDay:function(b){var a=this;clearTimeout(a.timer);b&&(a.timer=setTimeout(function(){a.destroy()},b))},send:function(b,a){var e;if(3!=this.state)return 0;e=v();ga(this.iframe.contentWindow,
{key:Z,mid:e,type:b,msg:a});return e}});p.prototype=new a;f(p.prototype,{id:"",channel:"lobby",url:"local",state:0,_bridge:function(){return!1},open:function(b){var a=this.channel,e=this.url,f=arguments,d=this.state,p;w(b)&&(p=b.indexOf("@"),~p?(a=b.substring(0,p)||a,e=b.substring(p+1)||e):a=b,1<f.length&&(this.credentials=aa.call(f,1)));da.test(e)&&(e=fa+e);if(2<d){if(a==this.channel&&e==this.url)return;this.close()}this.channel=a;this.url=e;2>d&&(this.id=v(),g(this,1),1==this.state&&R(this));return this},
close:function(){var b=this.state;0<b&&4>b&&Y(this);return this},_transmit:function(b,a,e){var f=this._bridge(S),d;if((d=f&&3==f.state&&3==this.state&&w(b)&&!m.call(H,b))&&!(d=!a)){a:{d=this.peers;var p=[],g,q;Q(a)||(a=[a]);for(q=a.length;q--;){g=a[q];g instanceof Subetha.Peer&&(g=g.id);if(!m.call(d,g)){d=0;break a}p.push(g)}d=p}d=a=d}return d?f.send("client",{type:b,from:this.id,to:a?[].concat(a):0,data:e}):!1}});f(P.prototype,{state:3});"function"!==typeof d.postMessage?p.prototype.open=function(){return this}:
z.body?t():(M(d,"DOMContentLoaded",t),M(d,"load",t));return N}r?define(f):x?module.exports=f():d.Subetha||(d.Subetha=f())}("function"===typeof define,"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);
!function(r,x,n,B){function h(){function h(d,v,f,n){return v&&"string"===typeof v&&"::"!=v.substring(0,2)&&d._transmit("subetha/event",n,{type:v,data:1<f.length?I.call(f,1):[]})}var u=x||r?require("subetha-client"):n.Subetha,I=Array.prototype.slice;u.Client.prototype.emit=function(d){return h(this,d,arguments,0)};u.Peer.prototype.send=function(d){return this.state?h(this._client,d,arguments,this.id):!1};u.msgType["subetha/event"]=function(d,v,f,n){var h=f.data;(f=f.type)&&"string"===typeof f&&"::"!=
f.substring(0,2)&&(v={data:[].concat(h),id:n.id,peer:v,timeStamp:n.timeStamp,type:f},h.length?d.fire.apply(d,[f,v].concat(h)):d.fire(f,v))};return u}r?define(h):x?module.exports=h():n.Subetha&&h()}("function"==typeof define,"undefined"!=typeof exports,this);
!function(r,x,n,B,h,E){function u(){function u(a){return a&&"string"===typeof a}function d(a,e,d){var f,g=e[0],k,h;if(!g||"string"!=typeof g)return!1;if(d)k=[d];else for(h in f=a.peers,k=[],f)k.push(h);if(h=k.length){f=w();e=e.length?t.call(e,1):[];if(!a._transmit("subetha/exchange",d,{xid:f,idx:0,phrase:g,data:e}))return!1;for(;h--;)v(a,f,k[h]).push(g);return f}}function v(a,e,d){var g,q;k.call(a,"_ax")||(g=a._ax={xids:{},cbs:{}},a.on("::disconnect",f));q=a._ax;e&&!k.call(q.xids,e)&&(g=q.xids[e]=
{pids:{},cnt:0});d&&!k.call(q.xids[e].pids,d)&&(q.xids[e].cnt++,g=[],g.endFn=function(){return!!A(a,e,d)},g=q.xids[e].pids[d]=g);return g}function f(){var a=this._ax.xids,e;this.off("::disconnect",f);for(e in a)J(this,e,a[e],1);delete this._ax}function J(a,e,d){var f,g,h;if(k.call(a,"_ax")&&(f=a._ax.xids,(g=f[e])&&k.call(g.pids,d)))return h=g.pids[d],delete g.pids[d],--g.cnt||delete f[e],a=a.peers[d],a._client.fire("::exchange-end",a,e,h.concat()),1}function A(a,e,d){a._transmit("subetha/exchange",
d,{xid:e,xkill:1});J(a,e,d)}var F=x||r?require("subetha"):h.Subetha,w=F.guid,C=F.Client,E=F.Peer,t=n.prototype.slice,k=Object.prototype.hasOwnProperty,g="function"===typeof n.isArray?n.isArray:function(a){return a instanceof n};C.prototype.adhoc=function(){var a=arguments,e=a[a.length-1];1<a.length&&"function"==typeof e&&(v(this),this._ax.cbs["="+t.call(a,0,-1).join()]=e);return this};C.prototype.unhoc=function(){var a,e;if(k.call(this,"_ax"))for(e in a=t.call(arguments),"function"==typeof a[a.length-
1]&&(a=a.slice(0,-1)),a="="+a.join(),chainRxp=new B("^"+a),a=this._ax.cbs,a)chainRxp.test(e)&&delete a[e];return this};C.prototype.ask=function(){return d(this,arguments)};E.prototype.ask=function(){return d(this._client,arguments,this.id)};E.prototype.endExchange=function(a){var e=this.id,d=this._client,f=this._ax,g=0,k=!a,h,n;if(f)for(n in f)if(h=n==a,k||h||f[n].chain[0]==a)if(A(d,e,n),g++,h)break;return g};Subetha.msgType["subetha/exchange"]=function(a,e,d,f){var h=e.id,n,r,x,m,w,z;"object"==typeof d&&
u(r=d.xid)&&(k.call(a,"_ax")?k.call(d,"xkill")?J(a,r,h):"number"==typeof(x=d.idx)&&u(z=d.phrase)&&g(n=d.data)?(v(a,r,h),m=a._ax,w=m.xids[r].pids[h],d="="+w.concat(z).join(),k.call(m.cbs,d)&&w.length==x?(w.push(z),e={end:w.endFn,reply:function(){var d,e;return k.call(m.xids,r)&&w.length==x+1?(d=arguments,e=d[0],w.push(e),d=t.call(d,1),a._transmit("subetha/exchange",h,{xid:r,idx:x+1,phrase:e,data:d})):!1},thread:w.concat(),data:n,id:f.id,peer:e,timeStamp:f.timeStamp,phrase:z,xid:r},cb=m.cbs[d],n.length?
cb.apply(a,[e].concat(n)):cb.call(a,e)):A(a,r,h)):A(a,r,h):A(a,r,h))};return F}r?define(u):x?module.exports=u():h.Subetha&&u()}("function"===typeof define,"undefined"!=typeof exports,Array,RegExp,this);